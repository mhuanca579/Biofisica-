<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NeuroNav-NanoTwin ‚Ä¢ Sangre ‚Üí BBB ‚Üí Tumor (Gu√≠a magn√©tica)</title>
<style>
  :root{
    --bg:#050814; --txt:#e9ecff; --mut:rgba(233,236,255,.75);
    --b:rgba(255,255,255,.12); --acc:#38bdf8; --acc2:#a78bfa;
    --good:#22c55e; --warn:#fbbf24; --bad:#fb7185;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Arial;overflow:hidden}
  .wrap{display:grid;grid-template-columns:390px 1fr;height:100vh}
  aside{padding:14px;border-right:1px solid rgba(255,255,255,.10);
        background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
        overflow:auto}
  h2{margin:0 0 6px;font-size:18px}
  .hint{font-size:12px;color:var(--mut);line-height:1.35;margin-bottom:10px}
  label{display:block;margin:10px 0 6px;color:var(--mut);font-size:12px}
  .val{float:right;font-weight:900;color:rgba(233,236,255,.92)}
  input[type="range"],select{width:100%}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{
    flex:1;min-width:120px;border:1px solid var(--b);
    background:rgba(255,255,255,.06);color:var(--txt);padding:10px;border-radius:12px;
    cursor:pointer;font-weight:900
  }
  button.primary{border-color:rgba(56,189,248,.35);background:rgba(56,189,248,.12)}
  .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .kpi{border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);border-radius:14px;padding:10px}
  .kpi div{font-size:12px;color:var(--mut)}
  .kpi b{font-size:18px}
  main{padding:12px}
  canvas{width:100%;display:block;border-radius:16px;background:#000;border:2px solid rgba(56,189,248,.35)}
  .legend{margin-top:10px;font-size:12px;color:var(--mut);line-height:1.35}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06)}
  @media(max-width:980px){body{overflow:auto}.wrap{grid-template-columns:1fr;height:auto}}
</style>
</head>
<body>

<div class="wrap">
  <aside>
    <h2>NeuroNav-NanoTwin</h2>
    <div class="hint">
      Simulaci√≥n educativa f√°cil de entender: <b>Sangre ‚Üí BBB ‚Üí Tumor</b>.<br>
      <b>Campo magn√©tico</b> y <b>permeabilidad BBB</b> aumentan el cruce; <b>pulsos</b> controlan cu√°ndo liberar el f√°rmaco.
    </div>

    <label>Tipo de nanorrobot</label>
    <select id="type">
      <option value="mag">Magneto-guiado (principal)</option>
      <option value="lig">Ligandos (afinidad bioqu√≠mica)</option>
      <option value="mix">H√≠brido (mag + ligandos)</option>
    </select>

    <label>Dosis (cantidad) <span class="val" id="vDose">240</span></label>
    <input id="dose" type="range" min="80" max="520" step="1" value="240">

    <label>Flujo sangu√≠neo <span class="val" id="vFlow">1.3</span></label>
    <input id="flow" type="range" min="0.6" max="2.6" step="0.1" value="1.3">

    <label>Campo magn√©tico (gu√≠a) <span class="val" id="vB">65</span></label>
    <input id="B" type="range" min="0" max="100" step="1" value="65">

    <label>Permeabilidad BBB <span class="val" id="vBBB">35</span></label>
    <input id="bbb" type="range" min="0" max="100" step="1" value="35">

    <label>Pulsos (ventanas ON) <span class="val" id="vPulse">50</span></label>
    <input id="pulse" type="range" min="0" max="100" step="1" value="50">

    <label>Liberaci√≥n en tumor <span class="val" id="vRel">55</span></label>
    <input id="rel" type="range" min="0" max="100" step="1" value="55">

    <label>Fuga fuera del objetivo <span class="val" id="vLeak">18</span></label>
    <input id="leak" type="range" min="0" max="100" step="1" value="18">

    <label>Aclaramiento <span class="val" id="vClear">25</span></label>
    <input id="clear" type="range" min="0" max="100" step="1" value="25">

    <div class="row">
      <button id="inject" class="primary">üíâ Inyectar</button>
      <button id="boost">‚ûï Refuerzo</button>
      <button id="reset">üîÑ Reiniciar</button>
    </div>

    <div class="kpis">
      <div class="kpi"><div>% llega al tumor</div><b id="kReach">0%</b></div>
      <div class="kpi"><div>AUC tumor (sim.)</div><b id="kAUCT">0.0</b></div>
      <div class="kpi"><div>Exposici√≥n sana</div><b id="kTox">0%</b></div>
      <div class="kpi"><div>Control tumoral</div><b id="kCtrl">85%</b></div>
    </div>

    <div class="hint" id="status" style="margin-top:10px">Estado: esperando inyecci√≥n.</div>

    <div class="legend">
      <span class="pill">Azul</span> con f√°rmaco ¬∑ <span class="pill">Amarillo</span> descargados ¬∑
      <span class="pill">BBB</span> barrera ¬∑ Heatmap: brillo = f√°rmaco en tumor
    </div>
  </aside>

  <main>
    <canvas id="cv" width="1200" height="720"></canvas>
  </main>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const cv = $("cv");
  const ctx = cv.getContext("2d");

  const ui = {
    type: $("type"), dose:$("dose"), flow:$("flow"), B:$("B"), bbb:$("bbb"),
    pulse:$("pulse"), rel:$("rel"), leak:$("leak"), clear:$("clear"),
    vDose:$("vDose"), vFlow:$("vFlow"), vB:$("vB"), vBBB:$("vBBB"),
    vPulse:$("vPulse"), vRel:$("vRel"), vLeak:$("vLeak"), vClear:$("vClear"),
    inject:$("inject"), boost:$("boost"), reset:$("reset"),
    kReach:$("kReach"), kAUCT:$("kAUCT"), kTox:$("kTox"), kCtrl:$("kCtrl"),
    status:$("status")
  };

  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const rand = (a,b)=>a+Math.random()*(b-a);

  // ZONAS: Sangre (arriba), BBB (l√≠nea), Cerebro (abajo), Tumor (dentro del cerebro)
  const blood = {x:70,y:110,w:cv.width-140,h:240,r:26};
  const bbbLineY = blood.y + blood.h + 35;
  const brain = {x:70,y:bbbLineY+25,w:cv.width-140,h:cv.height-(bbbLineY+45),r:26};
  const tumor = {x:cv.width-290, y:brain.y+brain.h*0.56, r:95};

  // Heatmap tumor
  const HM=30;
  const hm = new Float32Array(HM*HM);
  const hidx=(i,j)=>i*HM+j;

  function hmCell(x,y){
    const rx=(x-(tumor.x-tumor.r))/(tumor.r*2);
    const ry=(y-(tumor.y-tumor.r))/(tumor.r*2);
    const j=clamp(Math.floor(rx*HM),0,HM-1);
    const i=clamp(Math.floor(ry*HM),0,HM-1);
    return {i,j};
  }

  // Estado
  let bots=[];
  let total=0, arrived=0;
  let aucTum=0, aucSano=0;
  let ctrl=85;

  let mode="idle"; // idle | inject | sim
  let injT=0;

  // Animaci√≥n inyecci√≥n
  let syringe = {x:200,y:-160, plunger:0};

  function typeMul(){
    const t=ui.type.value;
    if(t==="mag") return {guide:1.25, bind:1.00, leak:1.00};
    if(t==="lig") return {guide:0.90, bind:1.25, leak:0.95};
    return {guide:1.15, bind:1.15, leak:1.05};
  }

  function flowField(y){
    const center=blood.y+blood.h/2;
    const R=blood.h/2;
    const d=y-center;
    const profile=clamp(1-(d*d)/(R*R),0,1);
    return profile * parseFloat(ui.flow.value);
  }

  function pushMetrics(reachPct=0, doseTum=0, tox=0, ctrlPct=85){
    window.parent?.postMessage({
      type:"NANO_METRICS",
      payload:{ reachPct, doseTumor:doseTum, toxicity:tox, tumorPct:ctrlPct }
    },"*");
  }

  function sync(){
    ui.vDose.textContent=ui.dose.value;
    ui.vFlow.textContent=ui.flow.value;
    ui.vB.textContent=ui.B.value;
    ui.vBBB.textContent=ui.bbb.value;
    ui.vPulse.textContent=ui.pulse.value;
    ui.vRel.textContent=ui.rel.value;
    ui.vLeak.textContent=ui.leak.value;
    ui.vClear.textContent=ui.clear.value;
  }
  ["input","change"].forEach(ev=>{
    ui.dose.addEventListener(ev,sync);
    ui.flow.addEventListener(ev,sync);
    ui.B.addEventListener(ev,sync);
    ui.bbb.addEventListener(ev,sync);
    ui.pulse.addEventListener(ev,sync);
    ui.rel.addEventListener(ev,sync);
    ui.leak.addEventListener(ev,sync);
    ui.clear.addEventListener(ev,sync);
  });
  sync();

  function resetAll(){
    bots=[];
    hm.fill(0);
    total=0; arrived=0;
    aucTum=0; aucSano=0;
    ctrl=85;
    mode="idle"; injT=0;
    syringe = {x:200,y:-160, plunger:0};

    ui.kReach.textContent="0%";
    ui.kAUCT.textContent="0.0";
    ui.kTox.textContent="0%";
    ui.kCtrl.textContent="85%";
    ui.status.textContent="Estado: esperando inyecci√≥n.";

    pushMetrics(0,0,0,85);
  }

  function spawn(mult=1){
    const n=Math.max(100, Math.floor(parseInt(ui.dose.value,10)*mult));
    total += n;
    for(let i=0;i<n;i++){
      bots.push({
        x: blood.x + rand(10,60),
        y: blood.y + rand(10,blood.h-10),
        vx:0,vy:0,
        drug:1.0,
        crossed:false,
        stuck:false,
        alive:true
      });
    }
  }

  function startInjection(){
    resetAll();
    mode="inject";
    injT=0;
    spawn(1);
    ui.status.textContent="üíâ Inyecci√≥n IV: entrando a la sangre‚Ä¶";
  }

  function step(dt){
    const M=typeMul();

    const B = (parseFloat(ui.B.value)/100) * M.guide;
    const BBB = (parseFloat(ui.bbb.value)/100);
    const pulse = (parseFloat(ui.pulse.value)/100);
    const rel = (parseFloat(ui.rel.value)/100);
    const leak = (parseFloat(ui.leak.value)/100) * M.leak;
    const clear = (parseFloat(ui.clear.value)/100);

    // Decaimiento heatmap
    const hmDecay = clamp(0.08 + clear*0.10, 0.04, 0.30);
    for(let k=0;k<hm.length;k++) hm[k] *= (1 - hmDecay*dt);

    // Eliminaci√≥n
    const kill = clamp(clear*0.13*dt, 0, 0.10);

    // Pulsos ON/OFF (simple y visible)
    const pulseGate = (Math.sin(performance.now()/480) * 0.5 + 0.5); // 0..1
    const pulseOn = (pulseGate < pulse);

    for(const b of bots){
      if(!b.alive) continue;
      if(Math.random()<kill){ b.alive=false; continue; }

      if(!b.crossed){
        // En sangre: flujo laminar + gu√≠a hacia zona de BBB
        const v = flowField(b.y);
        const brown=0.6;

        b.vx = v*3.1 + rand(-brown,brown);
        b.vy = rand(-brown,brown);

        const dx = tumor.x - b.x;
        const dy = (bbbLineY+18) - b.y;
        const dist = Math.hypot(dx,dy)+1e-6;

        const gate = clamp((b.x-(blood.x+blood.w*0.55))/(blood.w*0.45), 0, 1);
        const pull = B * gate;

        b.vx += (dx/dist)*pull*3.0;
        b.vy += (dy/dist)*pull*3.0;

        b.x += b.vx*70*dt;
        b.y += b.vy*70*dt;

        // Paredes vaso
        b.y = clamp(b.y, blood.y+6, blood.y+blood.h-6);

        // Recirculaci√≥n
        if(b.x > blood.x + blood.w + 60){
          b.x = blood.x + rand(10,60);
          b.y = blood.y + rand(10,blood.h-10);
        }

        // Cruce BBB si est√° cerca
        const nearBBB = (b.y > blood.y + blood.h - 18) && (b.x > blood.x + blood.w*0.60);
        if(nearBBB){
          // Probabilidad estable (no explosiva)
          const pCross = clamp((0.01 + 0.25*BBB + 0.20*B) * dt * 6, 0, 0.55);
          if(Math.random() < pCross){
            b.crossed = true;
            b.y = brain.y + rand(10,40);
            b.x = clamp(b.x + rand(-12,12), brain.x+10, brain.x+brain.w-10);
          }
        }

        // Fuga sist√©mica
        if(b.drug>0){
          const out = Math.min(b.drug, leak*0.020);
          b.drug -= out;
          aucSano += out;
        }
        continue;
      }

      // En cerebro: acercarse al tumor
      const brown=0.55;
      const dx=tumor.x-b.x, dy=tumor.y-b.y;
      const dist=Math.hypot(dx,dy)+1e-6;

      const guideBrain = (0.55 + 1.10*B) * 0.85;
      b.vx = (dx/dist)*guideBrain + rand(-brown,brown);
      b.vy = (dy/dist)*guideBrain + rand(-brown,brown);

      b.x += b.vx*55*dt;
      b.y += b.vy*55*dt;

      b.x = clamp(b.x, brain.x+8, brain.x+brain.w-8);
      b.y = clamp(b.y, brain.y+8, brain.y+brain.h-8);

      const inTum = Math.hypot(b.x-tumor.x, b.y-tumor.y) < tumor.r;

      if(inTum && !b.stuck){
        b.stuck = true;
        arrived++;
      }

      // Liberaci√≥n solo si pulso ON
      if(inTum && b.drug>0 && pulseOn){
        const relRate = 0.010 + 0.050*rel;
        const d = Math.min(b.drug, relRate*2.4);
        b.drug -= d;
        aucTum += d;

        const {i,j}=hmCell(b.x,b.y);
        const cell=(tumor.r*2)/HM;
        const cx=(tumor.x-tumor.r)+(j+0.5)*cell;
        const cy=(tumor.y-tumor.r)+(i+0.5)*cell;
        if((cx-tumor.x)**2 + (cy-tumor.y)**2 <= tumor.r*tumor.r){
          hm[hidx(i,j)] += d*2.4;
        }
      }

      // Fuga en cerebro (menor)
      if(b.drug>0){
        const out = Math.min(b.drug, leak*0.010);
        b.drug -= out;
        aucSano += out;
      }
    }

    const reachPct = total>0 ? (arrived/total)*100 : 0;
    const tox = clamp((aucSano/Math.max(1,total))*6000, 0, 100);

    const benefit = clamp(aucTum*0.035, 0, 70);
    const harm = clamp(tox*0.35, 0, 50);
    ctrl = clamp(35 + benefit - harm, 0, 100);

    ui.kReach.textContent = Math.round(reachPct)+"%";
    ui.kAUCT.textContent = aucTum.toFixed(1);
    ui.kTox.textContent = Math.round(tox)+"%";
    ui.kCtrl.textContent = Math.round(ctrl)+"%";

    pushMetrics(reachPct, aucTum, tox, ctrl);
  }

  function roundRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  function drawHeatmap(){
    const cell=(tumor.r*2)/HM;
    const maxV=0.9;
    for(let i=0;i<HM;i++){
      for(let j=0;j<HM;j++){
        const v=hm[hidx(i,j)];
        if(v<0.002) continue;
        const x=(tumor.x-tumor.r)+j*cell;
        const y=(tumor.y-tumor.r)+i*cell;
        const cx=x+cell/2, cy=y+cell/2;
        if((cx-tumor.x)**2 + (cy-tumor.y)**2 > tumor.r*tumor.r) continue;
        const a=clamp(v/maxV,0,1);
        ctx.fillStyle=`rgba(${Math.round(255*a)},${Math.round(210*a)},${Math.round(70*a)},${0.30*a})`;
        ctx.fillRect(x,y,cell,cell);
      }
    }
  }

  function drawSyringe(){
    const x=syringe.x, y=syringe.y;

    // cuerpo jeringa
    ctx.fillStyle="rgba(255,255,255,.86)";
    ctx.fillRect(x-20, y-30, 90, 24);

    // √©mbolo (se mueve)
    ctx.fillStyle="rgba(233,236,255,.90)";
    ctx.fillRect(x-18 + syringe.plunger*52, y-28, 10, 20);

    // tubo
    ctx.fillStyle="rgba(255,255,255,.94)";
    ctx.fillRect(x+18, y-6, 14, 160);

    // agarre
    ctx.fillStyle="rgba(255,255,255,.70)";
    ctx.fillRect(x+4, y+42, 44, 18);

    // punta
    ctx.fillStyle="rgba(251,191,36,.92)";
    ctx.beginPath();
    ctx.moveTo(x+25, y+142);
    ctx.lineTo(x+40, y+176);
    ctx.lineTo(x+10, y+176);
    ctx.closePath();
    ctx.fill();

    // "bolo" entrando
    ctx.fillStyle="rgba(56,189,248,.85)";
    ctx.beginPath();
    ctx.arc(x+25, y+180, 7, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle="rgba(233,236,255,.90)";
    ctx.font="bold 14px Arial";
    ctx.fillText("Inyecci√≥n IV", x+70, y-12);
  }

  function draw(){
    ctx.clearRect(0,0,cv.width,cv.height);

    const g=ctx.createLinearGradient(0,0,0,cv.height);
    g.addColorStop(0,"#000"); g.addColorStop(1,"#020617");
    ctx.fillStyle=g; ctx.fillRect(0,0,cv.width,cv.height);

    // t√≠tulos
    ctx.fillStyle="rgba(233,236,255,.92)";
    ctx.font="bold 20px Arial";
    ctx.fillText("Sangre ‚Üí BBB ‚Üí Tumor cerebral (Gu√≠a magn√©tica + liberaci√≥n por pulsos)", 18, 34);
    ctx.font="13px Arial";
    ctx.fillStyle="rgba(233,236,255,.70)";
    ctx.fillText("Azul: con f√°rmaco ‚Ä¢ Amarillo: descargados ‚Ä¢ Heatmap: f√°rmaco en tumor", 18, 56);

    // sangre
    roundRect(blood.x,blood.y,blood.w,blood.h,blood.r);
    ctx.fillStyle="rgba(148,163,184,.08)"; ctx.fill();
    ctx.strokeStyle="rgba(56,189,248,.25)"; ctx.lineWidth=2; ctx.stroke();

    // l√≠neas de flujo
    ctx.strokeStyle="rgba(56,189,248,.10)";
    ctx.lineWidth=1;
    for(let i=0;i<7;i++){
      const yy = blood.y + (i+1)*(blood.h/8);
      ctx.beginPath();
      ctx.moveTo(blood.x+12,yy);
      ctx.lineTo(blood.x+blood.w-12,yy);
      ctx.stroke();
    }

    // BBB
    ctx.strokeStyle="rgba(255,255,255,.24)";
    ctx.setLineDash([9,9]);
    ctx.beginPath();
    ctx.moveTo(80, bbbLineY);
    ctx.lineTo(cv.width-80, bbbLineY);
    ctx.stroke();
    ctx.setLineDash([]);

    ctx.fillStyle="rgba(233,236,255,.78)";
    ctx.font="bold 13px Arial";
    ctx.fillText("BBB (barrera hematoencef√°lica)", 90, bbbLineY-10);

    // cerebro
    roundRect(brain.x,brain.y,brain.w,brain.h,brain.r);
    ctx.fillStyle="rgba(167,139,250,.07)"; ctx.fill();
    ctx.strokeStyle="rgba(167,139,250,.20)"; ctx.lineWidth=2; ctx.stroke();

    // tumor + heatmap
    const halo=ctx.createRadialGradient(tumor.x,tumor.y,10,tumor.x,tumor.y,tumor.r*2.3);
    halo.addColorStop(0,"rgba(167,139,250,.16)");
    halo.addColorStop(1,"rgba(167,139,250,0)");
    ctx.fillStyle=halo;
    ctx.beginPath(); ctx.arc(tumor.x,tumor.y,tumor.r*2.3,0,Math.PI*2); ctx.fill();

    drawHeatmap();

    ctx.beginPath(); ctx.arc(tumor.x,tumor.y,tumor.r,0,Math.PI*2);
    ctx.fillStyle="rgba(167,139,250,.12)"; ctx.fill();
    ctx.lineWidth=6; ctx.strokeStyle="rgba(56,189,248,.45)"; ctx.stroke();

    // bots
    for(const b of bots){
      if(!b.alive) continue;
      const loaded=b.drug>0.55;
      ctx.fillStyle = loaded ? "rgba(56,189,248,.92)" : "rgba(251,191,36,.92)";
      ctx.beginPath();
      ctx.arc(b.x,b.y, b.stuck?3.9:3.0, 0, Math.PI*2);
      ctx.fill();
    }

    // jeringa
    if(mode==="inject") drawSyringe();
  }

  // Loop
  let last=performance.now();
  function loop(now){
    const dt = clamp((now-last)/1000, 0, 0.05);
    last=now;

    if(mode==="inject"){
      injT += dt;

      // bajar jeringa + empujar √©mbolo
      const enter = Math.min(1, injT/1.0);
      syringe.y = -160 + enter*(blood.y+40);
      syringe.plunger = clamp((injT-0.55)/1.1, 0, 1);

      // durante inyecci√≥n entra m√°s ‚Äúbolo‚Äù
      if(injT < 2.0 && Math.random()<0.32) spawn(0.06);

      if(injT >= 2.25){
        mode="sim";
        ui.status.textContent="‚úÖ Inyecci√≥n finalizada. Simulaci√≥n activa.";
      }
    }

    if(mode==="sim"){
      step(dt);
    }

    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // Botones
  ui.inject.onclick = () => startInjection();
  ui.boost.onclick  = () => {
    if(mode==="idle") startInjection();
    spawn(0.35);
    ui.status.textContent="‚ûï Refuerzo aplicado: m√°s nanorobots circulando.";
  };
  ui.reset.onclick  = () => resetAll();

  // Inicio
  resetAll();
})();
</script>

</body>
</html>

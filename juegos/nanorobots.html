<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Nanorobots ‚Ä¢ Inyecci√≥n IV ‚Üí sangre ‚Üí tumor</title>
<style>
  :root{
    --bg:#050814; --panel:#0f172a; --txt:#e9ecff; --mut:rgba(233,236,255,.72);
    --b:rgba(255,255,255,.12); --acc:#38bdf8; --acc2:#a78bfa; --good:#22c55e; --warn:#fbbf24; --bad:#fb7185;
    --r:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial;background:var(--bg);color:var(--txt);overflow:hidden}
  .wrap{display:grid;grid-template-columns:400px 1fr;height:100vh}
  .panel{padding:14px;border-right:1px solid rgba(255,255,255,.10);background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));overflow:auto}
  h2{margin:0 0 6px;font-size:18px}
  .hint{font-size:12px;color:var(--mut);line-height:1.35;margin-bottom:10px}
  label{display:block;margin:10px 0 6px;color:var(--mut);font-size:12px}
  .val{float:right;color:rgba(233,236,255,.85);font-weight:800}
  input[type="range"], select{width:100%}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{
    flex:1;min-width:120px;border:1px solid var(--b);
    background:rgba(255,255,255,.06);color:var(--txt);padding:10px;border-radius:12px;
    cursor:pointer;font-weight:900
  }
  button.primary{border-color:rgba(56,189,248,.35);background:rgba(56,189,248,.12)}
  .kpiGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .kpi{border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);border-radius:14px;padding:10px}
  .kpi div{font-size:12px;color:var(--mut)}
  .kpi b{font-size:18px}
  .stage{padding:12px}
  canvas{
    width:100%;height:auto;display:block;border-radius:var(--r);
    background:#000;border:2px solid rgba(56,189,248,.35)
  }
  .legend{margin-top:10px;font-size:12px;color:var(--mut);line-height:1.35}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-size:12px;color:var(--mut)}
  @media(max-width:980px){
    body{overflow:auto}
    .wrap{grid-template-columns:1fr;height:auto}
  }
</style>
</head>
<body>
<div class="wrap">
  <aside class="panel">
    <h2>Nanorobots (inyecci√≥n intravenosa)</h2>
    <div class="hint">
      Pulsa <b>üíâ Inyectar</b> para ver la animaci√≥n (aguja + √©mbolo + bolo). Luego ajusta par√°metros para guiar nanorobots al tumor.
    </div>

    <label>Tipo de nanorobot</label>
    <select id="carrier">
      <option value="lig">Ligandos (alta afinidad al tumor)</option>
      <option value="mag">Magn√©tico (guiado externo)</option>
      <option value="lip">Liposoma-nano (menos toxicidad)</option>
    </select>

    <label>Dosis (cantidad) <span class="val" id="vDose">220</span></label>
    <input id="dose" type="range" min="50" max="450" step="1" value="220">

    <label>Velocidad sangre (flujo) <span class="val" id="vFlow">1.4</span></label>
    <input id="flow" type="range" min="0.5" max="2.8" step="0.1" value="1.4">

    <label>Direccionamiento al tumor <span class="val" id="vTarget">70</span></label>
    <input id="target" type="range" min="0" max="100" step="1" value="70">

    <label>Adhesi√≥n (afinidad) <span class="val" id="vBind">60</span></label>
    <input id="bind" type="range" min="0" max="100" step="1" value="60">

    <label>Activaci√≥n local (libera en tumor) <span class="val" id="vAct">55</span></label>
    <input id="act" type="range" min="0" max="100" step="1" value="55">

    <label>Liberaci√≥n fuera objetivo (toxicidad) <span class="val" id="vOff">18</span></label>
    <input id="off" type="range" min="0" max="100" step="1" value="18">

    <label>Aclaramiento (h√≠gado/ri√±√≥n) <span class="val" id="vClear">25</span></label>
    <input id="clear" type="range" min="0" max="100" step="1" value="25">

    <div class="row">
      <button id="inject" class="primary">üíâ Inyectar</button>
      <button id="boost">‚ûï Refuerzo</button>
      <button id="reset">üîÑ Reiniciar</button>
    </div>

    <div class="kpiGrid">
      <div class="kpi"><div>% que llega al tumor</div><b id="kReach">0%</b></div>
      <div class="kpi"><div>F√°rmaco en tumor</div><b id="kDoseTum">0.0</b></div>
      <div class="kpi"><div>Toxicidad fuera objetivo</div><b id="kTox">0%</b></div>
      <div class="kpi"><div>Actividad tumoral</div><b id="kTum">85%</b></div>
    </div>

    <div class="hint" id="status" style="margin-top:10px;">Estado: esperando inyecci√≥n.</div>

    <div class="legend">
      <span class="pill">Azul</span> nanorobots cargados ¬∑ <span class="pill">Amarillo</span> descargados ¬∑
      <span class="pill">C√≠rculo</span> tumor ¬∑ Heatmap: brillo = concentraci√≥n
    </div>
  </aside>

  <main class="stage">
    <canvas id="cv" width="1200" height="640"></canvas>
    <canvas id="ch" width="1200" height="170" style="margin-top:10px;"></canvas>
  </main>
</div>

<script>
const cv=document.getElementById("cv"), ctx=cv.getContext("2d");
const ch=document.getElementById("ch"), cctx=ch.getContext("2d");

const ui={
  carrier:carrier,dose:dose,flow:flow,target:target,bind:bind,act:act,off:off,clear:clear,
  inject:inject,boost:boost,reset:reset,
  kReach:kReach,kDoseTum:kDoseTum,kTox:kTox,kTum:kTum,status:status,
  vDose:vDose,vFlow:vFlow,vTarget:vTarget,vBind:vBind,vAct:vAct,vOff:vOff,vClear:vClear
};

const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const rand=(a,b)=>a+Math.random()*(b-a);

// Escena: vaso sangu√≠neo + tumor
const vessel={x:70,y:130,w:cv.width-140,h:250,r:26};
const tumor={x:cv.width-260,y:460,r:85};

// Heatmap dentro tumor
const HM=30;
let hm=new Float32Array(HM*HM);
const idx=(i,j)=>i*HM+j;

function hmCell(x,y){
  const rx=(x-(tumor.x-tumor.r))/(tumor.r*2);
  const ry=(y-(tumor.y-tumor.r))/(tumor.r*2);
  const j=clamp(Math.floor(rx*HM),0,HM-1);
  const i=clamp(Math.floor(ry*HM),0,HM-1);
  return {i,j};
}

// Nanorobots
let bots=[];
let total=0,reached=0;
let drugTum=0,drugOff=0;
let tumorAct=0.85;
let t=0,hist=[];

let mode="idle"; // idle | inject | sim
let injectT=0;

// Animaci√≥n: aguja + jeringa + √©mbolo
let needle={x:220,y:-120, plunger:0}; // plunger 0..1

function typeMul(){
  const c=ui.carrier.value;
  if(c==="lig") return {target:1.28, bind:1.35, off:0.95, clear:1.05};
  if(c==="mag") return {target:1.18, bind:1.05, off:1.10, clear:1.10};
  return            {target:0.92, bind:0.86, off:0.70, clear:0.95};
}

function pushMetrics(reachPct=0,doseTum=0,tox=0,tumPct=85){
  window.parent?.postMessage({
    type:"NANO_METRICS",
    payload:{ reachPct, doseTumor:doseTum, toxicity:tox, tumorPct:tumPct }
  },"*");
}

function resetAll(){
  bots=[]; hm.fill(0);
  total=0; reached=0; drugTum=0; drugOff=0;
  tumorAct=0.85; t=0; hist=[];
  mode="idle"; injectT=0;
  needle={x:220,y:-120, plunger:0};
  ui.status.textContent="Estado: esperando inyecci√≥n.";
  ui.kReach.textContent="0%";
  ui.kDoseTum.textContent="0.0";
  ui.kTox.textContent="0%";
  ui.kTum.textContent="85%";
  pushMetrics(0,0,0,85);
}

function spawn(mult=1){
  const base=parseInt(ui.dose.value,10);
  const n=Math.max(80, Math.floor(base*mult));
  total += n;
  for(let i=0;i<n;i++){
    bots.push({
      x: vessel.x + rand(10,55),
      y: vessel.y + rand(10,vessel.h-10),
      vx:0,vy:0,
      drug:1.0,
      bound:false,
      alive:true
    });
  }
}

function startInjection(){
  resetAll();
  mode="inject";
  injectT=0;
  spawn(1.0);
  ui.status.textContent="üíâ Inyecci√≥n en curso: nanorobots entrando a la sangre‚Ä¶";
}

function flowField(y){
  const center=vessel.y+vessel.h/2;
  const R=vessel.h/2;
  const d=(y-center);
  const profile=clamp(1-(d*d)/(R*R),0,1);
  return profile * parseFloat(ui.flow.value);
}

function stepSim(dt){
  const M=typeMul();
  const targeting=(parseFloat(ui.target.value)/100)*M.target;
  const binding=(parseFloat(ui.bind.value)/100)*M.bind;
  const act=(parseFloat(ui.act.value)/100);
  const off=(parseFloat(ui.off.value)/100)*M.off;
  const clear=(parseFloat(ui.clear.value)/100)*M.clear;

  t += dt;

  // heatmap decay
  const hmDecay=clamp(0.06 + clear*0.06,0.03,0.22);
  for(let k=0;k<hm.length;k++) hm[k]*=(1-hmDecay*dt);

  // aclaramiento
  const kill=clamp(clear*0.12*dt,0,0.10);

  for(const b of bots){
    if(!b.alive) continue;
    if(Math.random()<kill){ b.alive=false; continue; }

    const v = flowField(b.y);
    const brown=0.65;

    b.vx = v*2.8 + rand(-brown,brown);
    b.vy = rand(-brown,brown);

    // atracci√≥n al tumor cuando va avanzando
    const dx=tumor.x-b.x, dy=tumor.y-b.y;
    const dist=Math.hypot(dx,dy)+1e-6;
    const gate=clamp((b.x-(vessel.x+vessel.w*0.55))/(vessel.w*0.45),0,1);
    const pull = targeting*0.95*gate;

    b.vx += (dx/dist)*pull*3.6;
    b.vy += (dy/dist)*pull*3.6;

    b.x += b.vx*72*dt;
    b.y += b.vy*72*dt;

    if(b.y < vessel.y+6) b.y=vessel.y+6;
    if(b.y > vessel.y+vessel.h-6) b.y=vessel.y+vessel.h-6;

    // recirculaci√≥n
    if(b.x > vessel.x+vessel.w+50){
      b.x = vessel.x + rand(10,55);
      b.y = vessel.y + rand(10,vessel.h-10);
    }

    // liberaci√≥n fuera objetivo (toxicidad)
    if(b.drug>0){
      const out=Math.min(b.drug, off*0.020);
      b.drug -= out;
      drugOff += out;
    }

    const inTum = dist < tumor.r;

    // adhesi√≥n
    if(inTum && !b.bound){
      const pBind = clamp(binding*0.70*dt,0,0.32);
      if(Math.random()<pBind){ b.bound=true; reached++; }
    }

    // liberaci√≥n en tumor (activaci√≥n)
    if(inTum && b.drug>0){
      const relRate = 0.020 + 0.040*act;
      const rel=Math.min(b.drug, relRate*2.2);
      b.drug -= rel;
      drugTum += rel;

      // depositar en heatmap
      const {i,j}=hmCell(b.x,b.y);
      const cell=(tumor.r*2)/HM;
      const cx=(tumor.x-tumor.r)+(j+0.5)*cell;
      const cy=(tumor.y-tumor.r)+(i+0.5)*cell;
      if((cx-tumor.x)**2+(cy-tumor.y)**2 <= tumor.r*tumor.r){
        hm[idx(i,j)] += rel*2.2;
      }
    }
  }

  // toxicidad 0..100
  const denom=Math.max(1,total);
  const tox = clamp((drugOff/denom)*5200,0,100);

  // actividad tumoral disminuye por f√°rmaco en tumor, empeora por tox
  tumorAct = clamp(tumorAct - drugTum*0.00013 + tox*0.00005, 0.10, 0.99);

  const reachPct = total>0 ? (reached/total)*100 : 0;

  ui.kReach.textContent = Math.round(reachPct)+"%";
  ui.kDoseTum.textContent = drugTum.toFixed(1);
  ui.kTox.textContent = Math.round(tox)+"%";
  ui.kTum.textContent = Math.round(tumorAct*100)+"%";

  hist.push({t, tox, tumor: tumorAct*100});
  hist = hist.filter(p => t - p.t <= 55);

  // enviar a index.html
  if(Math.floor(t*2) !== Math.floor((t-dt)*2)){
    pushMetrics(reachPct, drugTum, tox, tumorAct*100);
  }
}

function roundRect(c,x,y,w,h,r){
  c.beginPath();
  c.moveTo(x+r,y);
  c.arcTo(x+w,y,x+w,y+h,r);
  c.arcTo(x+w,y+h,x,y+h,r);
  c.arcTo(x,y+h,x,y,r);
  c.arcTo(x,y,x+w,y,r);
  c.closePath();
}

function drawHeatmap(){
  const cell=(tumor.r*2)/HM;
  const maxV=0.95;
  for(let i=0;i<HM;i++){
    for(let j=0;j<HM;j++){
      const v=hm[idx(i,j)];
      if(v<0.002) continue;
      const x=(tumor.x-tumor.r)+j*cell;
      const y=(tumor.y-tumor.r)+i*cell;
      const cx=x+cell/2, cy=y+cell/2;
      if((cx-tumor.x)**2+(cy-tumor.y)**2 > tumor.r*tumor.r) continue;
      const a=clamp(v/maxV,0,1);
      ctx.fillStyle=`rgba(${Math.round(255*a)},${Math.round(210*a)},${Math.round(70*a)},${0.30*a})`;
      ctx.fillRect(x,y,cell,cell);
    }
  }
}

function drawNeedle(){
  // aguja + jeringa + √©mbolo (plunger)
  const x=needle.x, y=needle.y;

  // cuerpo jeringa
  ctx.fillStyle="rgba(255,255,255,.85)";
  ctx.fillRect(x-22, y-40, 80, 28);

  // √©mbolo (se mueve)
  ctx.fillStyle="rgba(233,236,255,.85)";
  ctx.fillRect(x-20 + needle.plunger*42, y-38, 10, 24);

  // tubo
  ctx.fillStyle="rgba(255,255,255,.92)";
  ctx.fillRect(x+10, y-12, 14, 160);

  // aletas
  ctx.fillStyle="rgba(255,255,255,.70)";
  ctx.fillRect(x-5, y+40, 44, 18);

  // punta aguja
  ctx.fillStyle="rgba(251,191,36,.90)";
  ctx.beginPath();
  ctx.moveTo(x+17, y+148);
  ctx.lineTo(x+32, y+178);
  ctx.lineTo(x+2,  y+178);
  ctx.closePath();
  ctx.fill();

  // texto
  ctx.fillStyle="rgba(233,236,255,.88)";
  ctx.font="bold 14px Arial";
  ctx.fillText("Inyecci√≥n IV", x+50, y+10);
}

function drawScene(){
  ctx.clearRect(0,0,cv.width,cv.height);

  const g=ctx.createLinearGradient(0,0,0,cv.height);
  g.addColorStop(0,"#000");
  g.addColorStop(1,"#020617");
  ctx.fillStyle=g; ctx.fillRect(0,0,cv.width,cv.height);

  // t√≠tulo
  ctx.fillStyle="rgba(233,236,255,.92)";
  ctx.font="bold 20px Arial";
  ctx.fillText("Nanorobots: inyecci√≥n IV ‚Üí flujo sangu√≠neo ‚Üí tumor ‚Üí liberaci√≥n", 18, 30);
  ctx.font="13px Arial";
  ctx.fillStyle="rgba(233,236,255,.70)";
  ctx.fillText("Ajusta los sliders y mira el heatmap + m√©tricas + gr√°fica.", 18, 52);

  // vaso sangu√≠neo
  roundRect(ctx, vessel.x, vessel.y, vessel.w, vessel.h, vessel.r);
  ctx.fillStyle="rgba(148,163,184,.08)";
  ctx.fill();
  ctx.strokeStyle="rgba(56,189,248,.25)";
  ctx.lineWidth=2; ctx.stroke();

  // l√≠neas flujo
  ctx.strokeStyle="rgba(56,189,248,.10)";
  ctx.lineWidth=1;
  for(let i=0;i<7;i++){
    const yy=vessel.y+(i+1)*(vessel.h/8);
    ctx.beginPath(); ctx.moveTo(vessel.x+12,yy); ctx.lineTo(vessel.x+vessel.w-12,yy); ctx.stroke();
  }

  // tumor halo + heatmap
  const halo=ctx.createRadialGradient(tumor.x,tumor.y,10,tumor.x,tumor.y,tumor.r*2.2);
  halo.addColorStop(0,"rgba(167,139,250,.18)");
  halo.addColorStop(1,"rgba(167,139,250,0)");
  ctx.fillStyle=halo;
  ctx.beginPath(); ctx.arc(tumor.x,tumor.y,tumor.r*2.2,0,Math.PI*2); ctx.fill();

  drawHeatmap();

  ctx.beginPath(); ctx.arc(tumor.x,tumor.y,tumor.r,0,Math.PI*2);
  ctx.fillStyle="rgba(167,139,250,.12)"; ctx.fill();
  ctx.lineWidth=6; ctx.strokeStyle="rgba(56,189,248,.45)"; ctx.stroke();

  // n√∫cleo (actividad tumoral) m√°s visible si tumorAct alto
  ctx.beginPath(); ctx.arc(tumor.x,tumor.y,tumor.r*0.55,0,Math.PI*2);
  ctx.fillStyle=`rgba(251,191,36,${clamp(tumorAct-0.15,0.10,0.50)})`;
  ctx.fill();

  // nanorobots
  for(const b of bots){
    if(!b.alive) continue;
    const loaded=b.drug>0.6;
    ctx.fillStyle= loaded ? "rgba(56,189,248,.92)" : "rgba(251,191,36,.92)";
    ctx.beginPath();
    ctx.arc(b.x,b.y, b.bound?3.8:3.0, 0, Math.PI*2);
    ctx.fill();
  }

  if(mode==="inject"){
    drawNeedle();
  }
}

function drawChart(){
  cctx.clearRect(0,0,ch.width,ch.height);
  cctx.fillStyle="#000"; cctx.fillRect(0,0,ch.width,ch.height);
  cctx.strokeStyle="rgba(255,255,255,.10)";
  cctx.strokeRect(0,0,ch.width,ch.height);

  cctx.fillStyle="rgba(233,236,255,.75)";
  cctx.font="12px Arial";
  cctx.fillText("Actividad tumoral % (morado) y Toxicidad % (amarillo) en el tiempo (√∫ltimos 55s)", 10, 18);

  if(hist.length<2) return;

  const t0=hist[0].t, t1=hist[hist.length-1].t;
  const X=(tt)=>10 + ((tt-t0)/Math.max(0.0001,(t1-t0)))*(ch.width-20);
  const Y=(v)=>ch.height-16 - (v/100)*(ch.height-36);

  // tumor
  cctx.strokeStyle="rgba(167,139,250,.95)";
  cctx.lineWidth=2;
  cctx.beginPath();
  hist.forEach((p,i)=>{const x=X(p.t), y=Y(p.tumor); if(i===0)cctx.moveTo(x,y); else cctx.lineTo(x,y);});
  cctx.stroke();

  // tox
  cctx.strokeStyle="rgba(251,191,36,.95)";
  cctx.beginPath();
  hist.forEach((p,i)=>{const x=X(p.t), y=Y(p.tox); if(i===0)cctx.moveTo(x,y); else cctx.lineTo(x,y);});
  cctx.stroke();
}

// UI valores en vivo
function syncLabels(){
  ui.vDose.textContent = ui.dose.value;
  ui.vFlow.textContent = ui.flow.value;
  ui.vTarget.textContent = ui.target.value;
  ui.vBind.textContent = ui.bind.value;
  ui.vAct.textContent = ui.act.value;
  ui.vOff.textContent = ui.off.value;
  ui.vClear.textContent = ui.clear.value;
}
["input","change"].forEach(ev=>{
  ui.dose.addEventListener(ev,syncLabels);
  ui.flow.addEventListener(ev,syncLabels);
  ui.target.addEventListener(ev,syncLabels);
  ui.bind.addEventListener(ev,syncLabels);
  ui.act.addEventListener(ev,syncLabels);
  ui.off.addEventListener(ev,syncLabels);
  ui.clear.addEventListener(ev,syncLabels);
});
syncLabels();

// Loop
let last=performance.now();
function loop(now){
  const dt=clamp((now-last)/1000,0,0.05);
  last=now;

  if(mode==="inject"){
    injectT += dt;

    // bajar aguja y empujar √©mbolo
    const enter = Math.min(1, injectT/1.1);
    needle.y = -120 + enter*(vessel.y+30);
    needle.plunger = clamp((injectT-0.6)/1.2, 0, 1);

    // alimentar nanorobots durante la inyecci√≥n
    if(injectT < 2.0 && Math.random()<0.30) spawn(0.06);

    if(injectT >= 2.3){
      mode="sim";
      ui.status.textContent="‚úÖ Inyecci√≥n finalizada. Simulaci√≥n activa.";
    }
  }

  if(mode==="sim"){
    stepSim(dt);
  }

  drawScene();
  drawChart();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// Botones
ui.inject.onclick=()=> startInjection();
ui.boost.onclick=()=>{
  if(mode==="idle") startInjection();
  spawn(0.35);
  ui.status.textContent="‚ûï Refuerzo aplicado: m√°s nanorobots circulando.";
};
ui.reset.onclick=()=> resetAll();

</script>
</body>
</html>
